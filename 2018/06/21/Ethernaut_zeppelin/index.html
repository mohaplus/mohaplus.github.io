<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Ethernaut Zeppelin 学习 | 么哈么哈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="https://ethernaut.zeppelin.solutions/ 网站上列出了一系列智能合约在编写过程中可能产生的问题，可以帮助初学者很好的了解智能合约 https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md 帮助文档 花了一整天假装自己 AC 了所有的题目，这里把">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut Zeppelin 学习">
<meta property="og:url" content="http://mohamoha.club/2018/06/21/Ethernaut_zeppelin/index.html">
<meta property="og:site_name" content="么哈么哈">
<meta property="og:description" content="https://ethernaut.zeppelin.solutions/ 网站上列出了一系列智能合约在编写过程中可能产生的问题，可以帮助初学者很好的了解智能合约 https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md 帮助文档 花了一整天假装自己 AC 了所有的题目，这里把">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://mohamoha.club/zeppelin/ac.png">
<meta property="og:image" content="http://mohamoha.club/zeppelin/background.png">
<meta property="og:image" content="http://mohamoha.club/zeppelin/Environment.png">
<meta property="og:image" content="http://mohamoha.club/zeppelin/debug1.png">
<meta property="og:image" content="http://mohamoha.club/zeppelin/debug2.png">
<meta property="og:updated_time" content="2018-06-21T13:59:40.987Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ethernaut Zeppelin 学习">
<meta name="twitter:description" content="https://ethernaut.zeppelin.solutions/ 网站上列出了一系列智能合约在编写过程中可能产生的问题，可以帮助初学者很好的了解智能合约 https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md 帮助文档 花了一整天假装自己 AC 了所有的题目，这里把">
<meta name="twitter:image" content="http://mohamoha.club/zeppelin/ac.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">么哈么哈</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Too young, Too simple, Sometime naive</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://github.com">github</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://mohamoha.club"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Ethernaut_zeppelin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/21/Ethernaut_zeppelin/" class="article-date">
  <time datetime="2018-06-20T16:00:00.000Z" itemprop="datePublished">2018-06-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Ethernaut Zeppelin 学习
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://ethernaut.zeppelin.solutions/" target="_blank" rel="external">https://ethernaut.zeppelin.solutions/</a> 网站上列出了一系列智能合约在编写过程中可能产生的问题，可以帮助初学者很好的了解智能合约</p>
<p><a href="https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md" target="_blank" rel="external">https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md</a> 帮助文档</p>
<p>花了一整天假装自己 AC 了所有的题目，这里把过程中的一点总结和经验记录一下，留以备忘</p>
<p><img src="/zeppelin/ac.png" alt=""></p>
<h2 id="Hello"><a href="#Hello" class="headerlink" title="Hello"></a>Hello</h2><p>题目是用来帮助熟悉平台的。这里简单记录一下平台和 Remix 编辑器的基本操作</p>
<p>平台首先需要安装 MetaMask 插件并登陆账户，如果打开平台时没有登陆账户，那么登陆之后需要刷新页面使账户信息生效。</p>
<p>Remix 是非常好用的在线编辑平台，其不仅可以编译 solidity 代码生成自己的测试合约，也可以根据地址映射链上已有的合约</p>
<p><img src="/zeppelin/background.png" alt=""></p>
<p>在顶部菜单中可以选择合约运行的环境，运行合约的账户。并且可以配置执行合约代码时所带有的 gas 和 value 相当于调用合约时的 <code>.value().gas()</code></p>
<p><img src="/zeppelin/Environment.png" alt=""></p>
<p>在执行了合约代码之后可以点击下方的 debug 按钮对合约代码进行调试</p>
<p><img src="/zeppelin/debug1.png" alt=""></p>
<p>调试功能十分强大，可以查看运行时的栈，memory，opcode，等几乎所有的 EVM 关键信息</p>
<p><img src="/zeppelin/debug2.png" alt=""></p>
<a id="more"></a>
<h2 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h2><p>如下的智能合约，目的是通过修改 owner ，将 onwer 中所有的 balance 转给攻击者。  在合约的 Fallback 中可以修改 owner，向合约账户转账（send）就可以触发 fallback。题目主要帮助理解合约中各个函数的内容<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</div><div class="line"></div><div class="line">contract Fallback is Ownable &#123;</div><div class="line"></div><div class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public contributions;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Fallback</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</div><div class="line">    contributions[msg.sender] = <span class="number">1000</span> * (<span class="number">1</span> ether);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">contribute</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    <span class="built_in">require</span>(msg.value &lt; <span class="number">0.001</span> ether);</div><div class="line">    contributions[msg.sender] += msg.value;</div><div class="line">    <span class="keyword">if</span>(contributions[msg.sender] &gt; contributions[owner]) &#123;</div><div class="line">      owner = msg.sender;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getContribution</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> contributions[msg.sender];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</div><div class="line">    owner.transfer(<span class="keyword">this</span>.balance);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="built_in">require</span>(msg.value &gt; <span class="number">0</span> &amp;&amp; contributions[msg.sender] &gt; <span class="number">0</span>);</div><div class="line">    owner = msg.sender;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Fallout"><a href="#Fallout" class="headerlink" title="Fallout"></a>Fallout</h2><p>如下的智能合约，目的是将 owner 修改为攻击者。函数名写错了~ 提醒智能合约编写过程中注意编码。个人感觉不会有人把 <code>l</code> 写成 <code>1</code> 吧</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</div><div class="line"></div><div class="line">contract Fallout is Ownable &#123;</div><div class="line"></div><div class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) allocations;</div><div class="line"></div><div class="line">  <span class="comment">/* constructor */</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Fal1out</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    owner = msg.sender;</div><div class="line">    allocations[owner] = msg.value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">allocate</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    allocations[msg.sender] += msg.value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendAllocation</span>(<span class="params">address allocator</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="built_in">require</span>(allocations[allocator] &gt; <span class="number">0</span>);</div><div class="line">    allocator.transfer(allocations[allocator]);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">collectAllocations</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</div><div class="line">    msg.sender.transfer(<span class="keyword">this</span>.balance);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">allocatorBalance</span>(<span class="params">address allocator</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> allocations[allocator];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="FlipCoin"><a href="#FlipCoin" class="headerlink" title="FlipCoin"></a>FlipCoin</h2><p>在 solidity 的文档中明确说明，通过block 信息作为随机数是一个不好的方法，攻击者可以很容易的绕过。</p>
<p><a href="https://solidity-cn.readthedocs.io/zh/develop/units-and-global-variables.html#id3" target="_blank" rel="external">https://solidity-cn.readthedocs.io/zh/develop/units-and-global-variables.html#id3</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract CoinFlip &#123;</div><div class="line">  uint256 public consecutiveWins;</div><div class="line">  uint256 lastHash;</div><div class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">CoinFlip</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</div><div class="line">    consecutiveWins = <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flip</span>(<span class="params">bool _guess</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</div><div class="line">    uint256 blockValue = uint256(block.blockhash(block.number<span class="number">-1</span>));</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</div><div class="line">      revert();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    lastHash = blockValue;</div><div class="line">    uint256 coinFlip = uint256(uint256(blockValue) / FACTOR);</div><div class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (side == _guess) &#123;</div><div class="line">      consecutiveWins++;</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      consecutiveWins = <span class="number">0</span>;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Telephone"><a href="#Telephone" class="headerlink" title="Telephone"></a>Telephone</h2><p>通过 call 的方式调用其他合约中的代码，此时的 tx 仍然为原始合约调用时的信息，而 msg 经过转发已经变成了原始调用者合约。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract Telephone &#123;</div><div class="line"></div><div class="line">  address public owner;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Telephone</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</div><div class="line">    owner = msg.sender;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeOwner</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</div><div class="line">      owner = _owner;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h2><p>校验过程中的溢出情况，合约编写请尽量使用 SafeMath</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract Token &#123;</div><div class="line"></div><div class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) balances;</div><div class="line">  uint public totalSupply;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Token</span>(<span class="params">uint _initialSupply</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    balances[msg.sender] = totalSupply = _initialSupply;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</div><div class="line">    <span class="built_in">require</span>(balances[msg.sender] - _value &gt;= <span class="number">0</span>);</div><div class="line">    balances[msg.sender] -= _value;</div><div class="line">    balances[_to] += _value;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> balances[_owner];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h2><p>delegationCall 的作用就相当于引用了一个外部函数，使用函数中的代码来完成功能，函数上下文依然在当前合约</p>
<p>web3 提供了 sendTransfer 接口，可以直接给合约传递 msg。目前还不知道怎么在 Remix 中直接给合约传递 msg 信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract Delegate &#123;</div><div class="line"></div><div class="line">  address public owner;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Delegate</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    owner = _owner;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</div><div class="line">    owner = msg.sender;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">contract Delegation &#123;</div><div class="line"></div><div class="line">  address public owner;</div><div class="line">  Delegate delegate;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Delegation</span>(<span class="params">address _delegateAddress</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    delegate = Delegate(_delegateAddress);</div><div class="line">    owner = msg.sender;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(delegate.delegatecall(msg.data)) &#123;</div><div class="line">      <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Force"><a href="#Force" class="headerlink" title="Force"></a>Force</h2><p>获取以太币的方式有很多种，目前无论是合约还是“外部账户”都不能阻止有人给它们发送 以太币Ether。 合约可以对一个正常的转账做出反应并拒绝它，<strong>但还有些方法可以不通过创建消息来发送 以太币Ether。 其中一种方法就是单纯地向合约地址“挖矿”，另一种方法就是使用 selfdestruct(x) 。</strong></p>
<p>如果一个合约收到了 以太币Ether （且没有函数被调用），就会执行 fallback 函数。 如果没有 fallback 函数，那么 以太币Ether 会被拒收（同时会抛出异常）。 在 fallback 函数执行过程中，合约只能依靠此时可用的“gas 津贴”（2300 gas）来执行。 这笔津贴并不足以用来完成任何方式的 存储storage 访问。 为了确保你的合约可以通过这种方式收到 以太币Ether，请你核对 fallback 函数所需的 gas 数量 </p>
<p>有一种方法可以通过使用 addr.call.value(x)() 向接收合约发送更多的 gas。 这本质上跟 addr.transfer(x) 是一样的， 只不过前者发送所有剩余的 gas，并且使得接收者有能力执行更加昂贵的操作</p>
<p>因此如果不想让合约接受 ETH 的话，需要使用 this.balance 判断</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract Force &#123;<span class="comment">/*</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">                   MEOW ?</span></div><div class="line"><span class="comment">         /\_/\   /</span></div><div class="line"><span class="comment">    ____/ o o \</span></div><div class="line"><span class="comment">  /~____  =ø= /</span></div><div class="line"><span class="comment"> (______)__m_m)</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">*/</span>&#125;</div></pre></td></tr></table></figure>
<h2 id="King"><a href="#King" class="headerlink" title="King"></a>King</h2><p>以太坊上程序运行需要消耗 gas，一旦 gas 耗尽程序将不再继续执行。transfer 、call 等操作会触发 目标地址 fallback 合约代码的执行，从而接管程序执行流程，同时 msg 会变成当前合约传递的信息。</p>
<p>有两个概念非常重要：</p>
<ul>
<li><p>Gas Limit – 就是說你願意最多給多少Gas去完成這一個交易(包括:執行智能合約Execute Smart Contract，轉帳)。</p>
</li>
<li><p>Gas Price – 就是你願意支付多少Ether給(以太坊)Ethereum區塊鏈Miner礦工幫你執行這一筆交易。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</div><div class="line"></div><div class="line">contract King is Ownable &#123;</div><div class="line"></div><div class="line">  address public king;</div><div class="line">  uint public prize;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">King</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    king = msg.sender;</div><div class="line">    prize = msg.value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    <span class="built_in">require</span>(msg.value &gt;= prize || msg.sender == owner);</div><div class="line">    king.transfer(msg.value);</div><div class="line">    king = msg.sender;</div><div class="line">    prize = msg.value;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种先调用 transfer 、call 再进行其他操作的方法，容易引发 phishing-style attack 即有可能造成后面的语句不执行。</p>
<h2 id="Renentrace"><a href="#Renentrace" class="headerlink" title="Renentrace"></a>Renentrace</h2><p>web3.getBalance 方法可以获取地址中以太币的数量。</p>
<p>需要注意的是 uint 虽然是 uint256 的缩写，但是在作为 Call 函数的索引时，其计算 hash 时一定要写会原来的值 uint256</p>
<p>该合约可以进行 theDAO 攻击，在 msg.sender 的合约 fallback 代码中再次调用 withDraw 可以多次进入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract Reentrance &#123;</div><div class="line"></div><div class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params">address _to</span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    balances[_to] += msg.value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _who</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> balances[_who];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params">uint _amount</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</div><div class="line">      <span class="keyword">if</span>(msg.sender.call.value(_amount)()) &#123;</div><div class="line">        _amount;</div><div class="line">      &#125;</div><div class="line">      balances[msg.sender] -= _amount;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Elevator"><a href="#Elevator" class="headerlink" title="Elevator"></a>Elevator</h2><p>合约无法保证两次调用的结果一致，一个合约的内容不应该决定于另一个合约代码的运行结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line"></div><div class="line">interface Building &#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">view</span> <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>);</span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">contract</span> <span class="title">Elevator</span> </span>&#123;</div><div class="line">  bool public top;</div><div class="line">  uint public floor;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">goTo</span>(<span class="params">uint _floor</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    Building building = Building(msg.sender);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</div><div class="line">      floor = _floor;</div><div class="line">      top = building.isLastFloor(floor);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>题解</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">contract Hotel&#123;</div><div class="line">    Elevator ele;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">InstallElevator</span>(<span class="params">address ct</span>)</span>&#123;</div><div class="line">        ele = Elevator(ct);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint floor</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>( ele.floor() == floor)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Go</span>(<span class="params">uint _floor</span>) <span class="title">public</span></span>&#123;</div><div class="line">        ele.goTo(_floor);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Privacy"><a href="#Privacy" class="headerlink" title="Privacy"></a>Privacy</h2><p>区块链上没有东西是不可见的</p>
<p>可以参考 <a href="https://medium.com/aigang-network/how-to-read-ethereum-contract-storage-44252c8af925" target="_blank" rel="external">https://medium.com/aigang-network/how-to-read-ethereum-contract-storage-44252c8af925</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract Privacy &#123;</div><div class="line"></div><div class="line">  bool public locked = <span class="literal">true</span>;</div><div class="line">  uint256 public constant ID = block.timestamp;</div><div class="line">  uint8 private flattening = <span class="number">10</span>;</div><div class="line">  uint8 private denomination = <span class="number">255</span>;</div><div class="line">  uint16 private awkwardness = uint16(now);</div><div class="line">  bytes32[<span class="number">3</span>] private data;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Privacy</span>(<span class="params">bytes32[<span class="number">3</span>] _data</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    data = _data;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes16 _key</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="built_in">require</span>(_key == bytes16(data[<span class="number">2</span>]));</div><div class="line">    locked = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`</span></div><div class="line"><span class="comment">      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,</span></div><div class="line"><span class="comment">      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\</span></div><div class="line"><span class="comment">      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)</span></div><div class="line"><span class="comment">      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU</span></div><div class="line"><span class="comment">  */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Gatekeeper-One"><a href="#Gatekeeper-One" class="headerlink" title="Gatekeeper One"></a>Gatekeeper One</h2><p>注意各种长度的 uint 在转化时采用大端计算，即从后面开始直接截断。</p>
<p>这里考察了合约的调试能力，在 Remix 中点击 debug 可以单步调试 instr，其中 GAS 语句为获取 msg.gas，其中的值会保存在栈中。单步到这条语句，根据实际的值修改 gas</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract GatekeeperOne &#123;</div><div class="line"></div><div class="line">  address public entrant;</div><div class="line"></div><div class="line">  modifier gateOne() &#123;</div><div class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</div><div class="line">    _;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  modifier gateTwo() &#123;</div><div class="line">    <span class="built_in">require</span>(msg.gas % <span class="number">8191</span> == <span class="number">0</span>);</div><div class="line">    _;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  modifier gateThree(bytes8 _gateKey) &#123;</div><div class="line">    <span class="built_in">require</span>(uint32(_gateKey) == uint16(_gateKey));</div><div class="line">    <span class="built_in">require</span>(uint32(_gateKey) != uint64(_gateKey));</div><div class="line">    <span class="built_in">require</span>(uint32(_gateKey) == uint16(tx.origin));</div><div class="line">    _;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</div><div class="line">    entrant = tx.origin;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">contract BatteringRam &#123;</div><div class="line">    address public gate;</div><div class="line">    </div><div class="line">    event GateKey(uint64 key);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SetTargetGate</span>(<span class="params">address _gate</span>)</span>&#123;</div><div class="line">        gate = _gate;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Attack</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        uint64 gateKey = uint16(tx.origin);</div><div class="line">        gateKey += <span class="number">0x10adbeef00000000</span>;</div><div class="line">        </div><div class="line">        GateKey(gateKey);</div><div class="line">        gate.call.gas(<span class="number">215</span>+<span class="number">8191</span>*<span class="number">10</span>)(bytes4(keccak256(<span class="string">"enter(bytes8)"</span>)), bytes8(gateKey));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="GateKeeper-Two"><a href="#GateKeeper-Two" class="headerlink" title="GateKeeper Two"></a>GateKeeper Two</h2><p>使用内联汇编 <code>extcodesize(addr)</code> 可以获取一个账户中的代码大小， <code>caller</code> 相当于 msg.sender ，当一个合约仍在部署阶段时，在链上是获取不到合约的代码信息的。</p>
<p><a href="http://www.tryblockchain.org/blockchain-solidity-assembly.html" target="_blank" rel="external">http://www.tryblockchain.org/blockchain-solidity-assembly.html</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line">contract GatekeeperTwo &#123;</div><div class="line"></div><div class="line">  address public entrant;</div><div class="line"></div><div class="line">  modifier gateOne() &#123;</div><div class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</div><div class="line">    _;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  modifier gateTwo() &#123;</div><div class="line">    uint x;</div><div class="line">    assembly &#123; <span class="attr">x</span> := extcodesize(caller) &#125;</div><div class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>);</div><div class="line">    _;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  modifier gateThree(bytes8 _gateKey) &#123;</div><div class="line">    <span class="built_in">require</span>(uint64(keccak256(msg.sender)) ^ uint64(_gateKey) == uint64(<span class="number">0</span>) - <span class="number">1</span>);</div><div class="line">    _;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</div><div class="line">    entrant = tx.origin;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Naught-Coin"><a href="#Naught-Coin" class="headerlink" title="Naught Coin"></a>Naught Coin</h2><p>非常典型的没有限定 transferFrom 权限的 ERC20 Token</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/token/ERC20/StandardToken.sol'</span>;</div><div class="line"></div><div class="line"> contract NaughtCoin is StandardToken &#123;</div><div class="line"></div><div class="line">  string public constant name = <span class="string">'NaughtCoin'</span>;</div><div class="line">  string public constant symbol = <span class="string">'0x0'</span>;</div><div class="line">  uint public constant decimals = <span class="number">18</span>;</div><div class="line">  uint public timeLock = now + <span class="number">10</span> years;</div><div class="line">  uint public INITIAL_SUPPLY = <span class="number">1000000</span> * (<span class="number">10</span> ** decimals);</div><div class="line">  address public player;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">NaughtCoin</span>(<span class="params">address _player</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    player = _player;</div><div class="line">    totalSupply_ = INITIAL_SUPPLY;</div><div class="line">    balances[player] = INITIAL_SUPPLY;</div><div class="line">    Transfer(<span class="number">0x0</span>, player, INITIAL_SUPPLY);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">lockTokens</span> <span class="title">public</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</div><div class="line">    <span class="keyword">super</span>.transfer(_to, _value);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></div><div class="line">  modifier lockTokens() &#123;</div><div class="line">    <span class="keyword">if</span> (msg.sender == player) &#123;</div><div class="line">      <span class="built_in">require</span>(now &gt; timeLock);</div><div class="line">      <span class="keyword">if</span> (now &lt; timeLock) &#123;</div><div class="line">        _;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">     _;</div><div class="line">    &#125;</div><div class="line">  &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Preservation"><a href="#Preservation" class="headerlink" title="Preservation"></a>Preservation</h2><p>delegateCall 方法仅仅使用目标合约的代码， 其余的 storage 等数据均使用自己的，合约的访问操作 <code>sstore(p, v)</code> 是根据代码中记录的标准位置而来。这就使得某些访存操作会错误的处理对象。</p>
<p>访存操作指令，可以看到访存的位置是硬编码在指令中的。当使用 delegateCall 时，Storage 是原合约的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">JUMPDEST</div><div class="line">DUP1</div><div class="line">PUSH1 00</div><div class="line">DUP2</div><div class="line">SWAP1</div><div class="line">SSTORE</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</div><div class="line"></div><div class="line">contract Preservation &#123;</div><div class="line"></div><div class="line">  <span class="comment">// public library contracts </span></div><div class="line">  address public timeZone1Library;</div><div class="line">  address public timeZone2Library;</div><div class="line">  address public owner; </div><div class="line">  uint storedTime;</div><div class="line">  <span class="comment">// Sets the function signature for delegatecall</span></div><div class="line">  bytes4 constant setTimeSignature = bytes4(keccak256(<span class="string">"setTime(uint256)"</span>));</div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public &#123;</div><div class="line">    timeZone1Library = _timeZone1LibraryAddress; </div><div class="line">    timeZone2Library = _timeZone2LibraryAddress; </div><div class="line">    owner = msg.sender;</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  <span class="comment">// set the time for timezone 1</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFirstTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    timeZone1Library.delegatecall(setTimeSignature, _timeStamp);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// set the time for timezone 2</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSecondTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    timeZone2Library.delegatecall(setTimeSignature, _timeStamp);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Simple library contract to set the time</span></div><div class="line">contract LibraryContract &#123;</div><div class="line"></div><div class="line">  <span class="comment">// stores a timestamp </span></div><div class="line">  uint storedTime;  </div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setTime</span>(<span class="params">uint _time</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    storedTime = _time;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Locked"><a href="#Locked" class="headerlink" title="Locked"></a>Locked</h2><p>在合约中新建 结构体或者数组 时其存储位置是 storage，对它进行的访问很容易造成溢出。（其实这里不是很明白，以后抽时间解决）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>; </div><div class="line"></div><div class="line"><span class="comment">// A Locked Name Registrar</span></div><div class="line">contract Locked &#123;</div><div class="line"></div><div class="line">    bool public unlocked = <span class="literal">false</span>;  <span class="comment">// registrar locked, no name updates</span></div><div class="line">    </div><div class="line">    struct NameRecord &#123; <span class="comment">// map hashes to addresses</span></div><div class="line">        bytes32 name; <span class="comment">// </span></div><div class="line">        address mappedAddress;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> NameRecord) public registeredNameRecord; <span class="comment">// records who registered names </span></div><div class="line">    mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> address) public resolve; <span class="comment">// resolves hashes to addresses</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">bytes32 _name, address _mappedAddress</span>) <span class="title">public</span> </span>&#123;</div><div class="line">        <span class="comment">// set up the new NameRecord</span></div><div class="line">        NameRecord newRecord;</div><div class="line">        newRecord.name = _name;</div><div class="line">        newRecord.mappedAddress = _mappedAddress; </div><div class="line"></div><div class="line">        resolve[_name] = _mappedAddress;</div><div class="line">        registeredNameRecord[msg.sender] = newRecord; </div><div class="line"></div><div class="line">        <span class="built_in">require</span>(unlocked); <span class="comment">// only allow registrations if contract is unlocked</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h2><p>区块链上一切都是透明的，即使弄丢了 Token 地址，也可以从区块中根据交易记录找回。</p>
<p>通过 selfdestruct 指令可以销毁某个 Token 并将剩余的以太转移到某一账户中去</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</div><div class="line"></div><div class="line">contract Recovery &#123;</div><div class="line"></div><div class="line">  <span class="comment">//generate tokens</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">generateToken</span>(<span class="params">string _name, uint256 _initialSupply</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    <span class="keyword">new</span> SimpleToken(_name, msg.sender, _initialSupply);</div><div class="line">  </div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">contract SimpleToken &#123;</div><div class="line"></div><div class="line">  <span class="comment">// public variables</span></div><div class="line">  string public name;</div><div class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</div><div class="line"></div><div class="line">  <span class="comment">// constructor</span></div><div class="line">  <span class="keyword">constructor</span>(string _name, address _creator, uint256 _initialSupply) public &#123;</div><div class="line">    name = _name;</div><div class="line">    balances[_creator] = _initialSupply;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// collect ether in return for tokens</span></div><div class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</div><div class="line">    balances[msg.sender] = msg.value*<span class="number">10</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// allow transfers of tokens</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _amount</span>) <span class="title">public</span> </span>&#123; </div><div class="line">    <span class="built_in">require</span>(balances[msg.sender] &gt;= _amount);</div><div class="line">    balances[msg.sender] -= _amount;</div><div class="line">    balances[_to] = _amount;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// clean up after ourselves</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">address _to</span>) <span class="title">public</span> </span>&#123;</div><div class="line">    selfdestruct(_to);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>做题过程中参考了很多很多。感谢所有乐于分享的朋友们。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/06/21/Ethernaut_zeppelin/" data-id="cjli23fu70008f4uuwexp8lzd" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/06/21/Ethernaut_zeppelin/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/23/EOS_build/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          EOS 搭建指南
        
      </div>
    </a>
  
  
    <a href="/2018/06/03/Bypass_ACG_with_OpenProcess/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Bypass ACG With OpenProcess</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/08/31/VaribleOverlap/">ETH Varible Overlap</a>
          </li>
        
          <li>
            <a href="/2018/07/23/EOS_build/">EOS 搭建指南</a>
          </li>
        
          <li>
            <a href="/2018/06/21/Ethernaut_zeppelin/">Ethernaut Zeppelin 学习</a>
          </li>
        
          <li>
            <a href="/2018/06/03/Bypass_ACG_with_OpenProcess/">Bypass ACG With OpenProcess</a>
          </li>
        
          <li>
            <a href="/2018/05/22/MapViewOfSection_and_Shared_Memory/">MapViewOfSection and Shared-Memory</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget tag">
    <h3 class="title">Site Links</h3>
    <ul class="entry">
    <li><a href="http://5alt.me" title="5alt">5alt's Blog</a></li>
    </ul>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 mohaplus<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com" class="mobile-nav-link">github</a>
  
</nav>
    
<script>
  var disqus_shortname = 'mohamoha';
  
  var disqus_url = 'http://mohamoha.club/2018/06/21/Ethernaut_zeppelin/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>