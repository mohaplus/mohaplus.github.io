<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Bypass ACG With UnmapViewOfFile | 么哈么哈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;amp;can=1&amp;amp;q=&amp;amp;start=1200 p0 研究者 ifratric 提出的一种绕过 ACG 保护的方案，即通过调用函数 UnmapViewOfFile 来预先修改内存块内容，从而在可执行页上加入攻击者自定义代码。 Remote JIT开启了 AC">
<meta property="og:type" content="article">
<meta property="og:title" content="Bypass ACG With UnmapViewOfFile">
<meta property="og:url" content="http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/index.html">
<meta property="og:site_name" content="么哈么哈">
<meta property="og:description" content="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;amp;can=1&amp;amp;q=&amp;amp;start=1200 p0 研究者 ifratric 提出的一种绕过 ACG 保护的方案，即通过调用函数 UnmapViewOfFile 来预先修改内存块内容，从而在可执行页上加入攻击者自定义代码。 Remote JIT开启了 AC">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-04-25T09:40:29.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bypass ACG With UnmapViewOfFile">
<meta name="twitter:description" content="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;amp;can=1&amp;amp;q=&amp;amp;start=1200 p0 研究者 ifratric 提出的一种绕过 ACG 保护的方案，即通过调用函数 UnmapViewOfFile 来预先修改内存块内容，从而在可执行页上加入攻击者自定义代码。 Remote JIT开启了 AC">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">么哈么哈</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Too young, Too simple, Sometime naive</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://github.com">github</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://mohamoha.club"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Bypass_ACG_with_UnmapViewOfFile" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/" class="article-date">
  <time datetime="2018-04-24T16:00:00.000Z" itemprop="datePublished">2018-04-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Bypass ACG With UnmapViewOfFile
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200" target="_blank" rel="external">https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200</a> p0 研究者 ifratric 提出的一种绕过 ACG 保护的方案，即通过调用函数 <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366882.aspx" target="_blank" rel="external"><code>UnmapViewOfFile</code></a> 来预先修改内存块内容，从而在可执行页上加入攻击者自定义代码。</p>
<h1 id="Remote-JIT"><a href="#Remote-JIT" class="headerlink" title="Remote JIT"></a>Remote JIT</h1><p>开启了 ACG 保护之后进程将不能够申请未签名代码页。但是现代浏览器为了提高响应效率，都提供了 JIT 功能用于把 JS 代码编译成本地代码。该功能的实现依赖于在进程空间中动态的生成未签名的代码页。为了同时支持 ACG 和 JIT，Chakra 将其 JIT 功能移动到一个单独的进程中，该进程在其独立的沙箱中运行。JIT进程负责将 JavaScript 编译为本地代码并将其映射到请求进程。渲染进程本身不允许直接映射或修改其自己的JIT代码页。</p>
<h2 id="JIT-地址管理"><a href="#JIT-地址管理" class="headerlink" title="JIT 地址管理"></a>JIT 地址管理</h2><p>（由于笔者对于 ACG 的分析基于的 Edge 版本较老因此，可能有些地方不匹配）<br>远程分配的地址空间来源于本进程中的 <code>PreReservedSectionAllocWrapper</code> 对象，该对象在 JIT 进程启动时进行初始化，专门负责管理那些远程保留空间。对象的结构简单表示如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PreReservedSectionAllocWrapper</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">    BVStatic&lt;PreReservedAllocationSegmentCount&gt;     freeSegments;                  <span class="comment">//0x00             // 用于索引整块内存空间，检查内存状态</span></div><div class="line">    LPVOID                                          preReservedStartAddress;       <span class="comment">//0x200            // 当前应该分配出去的地址</span></div><div class="line">    CriticalSection                                 cs;                            <span class="comment">//0x208</span></div><div class="line">                        |-  PRTL_CRITICAL_SECTION_DEBUG DebugInfo;                 <span class="comment">//0x208</span></div><div class="line">                        |-  LONG LockCount;                                        <span class="comment">//0x210</span></div><div class="line">                        |-  LONG RecursionCount;                                   <span class="comment">//0x214</span></div><div class="line">                        |-  HANDLE OwningThread;                                   <span class="comment">//0x218   from the thread's ClientId-&gt;UniqueThread</span></div><div class="line">                        |-  HANDLE LockSemaphore;                                  <span class="comment">//0x220</span></div><div class="line">                        |-  ULONG_PTR SpinCount                                    <span class="comment">//0x228                                                                      </span></div><div class="line">    HANDLE process;                                                                <span class="comment">//0x230             // 远程进程句柄</span></div><div class="line">    HANDLE section;                                                                <span class="comment">//0x238             // 远程地址 section 句柄</span></div><div class="line">    EnsurePreReservedRegionInternal();                                             <span class="comment">// 用于检查是否还存在可管理的 RESERVE 属性内存，若不存在，则在分配之</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>其中 <code>preReservedStartAddress</code> 用于管理远程空间的可操作地址，这块空间调用函数 <code>PreReservedSectionAllocWrapper::EnsurePreReservedRegionInternal</code> 在远程进程中进行映射，映射之后远程进程中\这块地址的内存属性为 Mapped，可在远程进程中查看到。<code>PreReservedSectionAllocWrapper</code>  函数及调用栈如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">00000090`871fea90 00007ff8`71b40580 chakra!Memory::PreReservedSectionAllocWrapper::EnsurePreReservedRegionInternal+0x36</div><div class="line">00000090`871fead0 00007ff8`71d944f9 chakra!Memory::PreReservedSectionAllocWrapper::EnsurePreReservedRegion+0x50</div><div class="line">00000090`871feb10 00007ff8`71d942f6 chakra!&lt;lambda_59f4555218dfa2b0373b0fdca25e82c3&gt;::operator()+0xb9</div><div class="line">00000090`871feb40 00007ff8`7206252d chakra!ServerCallWrapper&lt;&lt;lambda_59f4555218dfa2b0373b0fdca25e82c3&gt; &gt;+0x56</div><div class="line">00000090`871feb80 00007ff8`94c29083 chakra!ServerInitializeThreadContext+0x17d</div></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">__int64 __fastcall Memory::PreReservedSectionAllocWrapper::EnsurePreReservedRegionInternal(Memory::PreReservedSectionAllocWrapper *<span class="keyword">this</span>)</div><div class="line">&#123;</div><div class="line">  Memory::PreReservedSectionAllocWrapper *v1; <span class="comment">// rbx@1</span></div><div class="line">  HANDLE renderProcessHandle; <span class="comment">// rdx@4</span></div><div class="line">  __int64 v4; <span class="comment">// rax@5</span></div><div class="line">  ULONG v5; <span class="comment">// [rsp+48h] [rbp-1h]@4</span></div><div class="line">  HANDLE hSection; <span class="comment">// [rsp+50h] [rbp+7h]@3</span></div><div class="line">  PVOID v7; <span class="comment">// [rsp+58h] [rbp+Fh]@1</span></div><div class="line">  LARGE_INTEGER sectionSize; <span class="comment">// [rsp+60h] [rbp+17h]@3</span></div><div class="line">  SIZE_T v9; <span class="comment">// [rsp+68h] [rbp+1Fh]@4</span></div><div class="line">  OBJECT_ATTRIBUTES objAttrs; <span class="comment">// [rsp+70h] [rbp+27h]@3</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (! <span class="keyword">this</span>-&gt;preReservedStartAddress )</div><div class="line">  &#123;</div><div class="line">    objAttrs.RootDirectory = <span class="number">0</span>i64;</div><div class="line">    objAttrs.ObjectName = <span class="number">0</span>i64;</div><div class="line">    hSection = <span class="number">0</span>i64;</div><div class="line">    sectionSize.QuadPart = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(dword_1807C9C54 &lt;&lt; <span class="number">24</span>);</div><div class="line">    objAttrs.Length = <span class="number">48</span>;</div><div class="line">    objAttrs.Attributes = <span class="number">512</span>;     <span class="comment">// OBJ_KERNEL_HANDLE</span></div><div class="line">    _mm_storeu_si128((__m128i *)&amp;objAttrs.SecurityDescriptor, <span class="number">0</span>i64);</div><div class="line">    <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)NtCreateSection(&amp;hSection, <span class="number">15</span>i64, &amp;objAttrs, &amp;sectionSize, <span class="number">64</span>, <span class="number">0x4000000</span>, <span class="number">0</span>i64) )</div><div class="line">    &#123;</div><div class="line">      renderProcessHandle = (HANDLE)*(<span class="keyword">this</span>-&gt;process);</div><div class="line">      v9 = <span class="number">0</span>i64;</div><div class="line">      v5 = <span class="number">1073741840</span>;</div><div class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)NtMapViewOfSection(</div><div class="line">                           hSection,</div><div class="line">                           renderProcessHandle,</div><div class="line">                           &amp;v7,</div><div class="line">                           <span class="number">0</span>i64,</div><div class="line">                           <span class="number">0</span>i64,</div><div class="line">                           <span class="number">0</span>i64,</div><div class="line">                           &amp;v9,</div><div class="line">                           <span class="number">2</span>,      <span class="comment">// ViewUnmap</span></div><div class="line">                           <span class="number">0</span>,</div><div class="line">                           *(_QWORD *)&amp;v5)</div><div class="line">        || (v4 = (__int64)v7) == <span class="number">0</span> )</div><div class="line">      &#123;</div><div class="line">        NtClose(hSection);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        *(<span class="keyword">this</span>-&gt;section) = hSection;</div><div class="line">        *(<span class="keyword">this</span>-&gt;preReservedStartAddress) = v7;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> _guard_ss_common_verify_stub();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际进行 JIT 代码编译时，JIT 进程通过 PreReservedSectionAllocWrapper 获取之前映射的地址，使用 <code>VirtualAllocEx</code> 将 Render 进程中之前 reserverd 的地址空间 commit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> *__fastcall Memory::PreReservedSectionAllocWrapper::Alloc(Memory::PreReservedSectionAllocWrapper *<span class="keyword">this</span>, <span class="keyword">void</span> *a2, SIZE_T a3, <span class="keyword">int</span> a4)</div><div class="line">&#123;</div><div class="line">  Memory::PreReservedSectionAllocWrapper *v4; <span class="comment">// rdi@1</span></div><div class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span> *<span class="title">v5</span>;</span> <span class="comment">// rbp@1</span></div><div class="line">  __int64 v6; <span class="comment">// rdx@1</span></div><div class="line">  <span class="keyword">bool</span> v7; <span class="comment">// r8@1</span></div><div class="line">  <span class="keyword">signed</span> __int64 v8; <span class="comment">// rsi@2</span></div><div class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// r15@2</span></div><div class="line">  <span class="keyword">void</span> *v10; <span class="comment">// rbx@3</span></div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// eax@8</span></div><div class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+30h] [rbp-48h]@5</span></div><div class="line">  __int64 v14; <span class="comment">// [rsp+38h] [rbp-40h]@1</span></div><div class="line">  Memory::PreReservedSectionAllocWrapper *v15; <span class="comment">// [rsp+40h] [rbp-38h]@1</span></div><div class="line">  <span class="keyword">void</span> *lpAddress; <span class="comment">// [rsp+88h] [rbp+10h]@1</span></div><div class="line">  SIZE_T dwSize; <span class="comment">// [rsp+90h] [rbp+18h]@1</span></div><div class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+98h] [rbp+20h]@1</span></div><div class="line"></div><div class="line">  v18 = a4;</div><div class="line">  dwSize = a3;</div><div class="line">  lpAddress = a2;</div><div class="line">  v14 = <span class="number">-2</span>i64;</div><div class="line">  v4 = <span class="keyword">this</span>;</div><div class="line">  v5 = (struct _RTL_CRITICAL_SECTION *)((<span class="keyword">char</span> *)<span class="keyword">this</span> + <span class="number">520</span>);</div><div class="line">  v15 = (Memory::PreReservedSectionAllocWrapper *)((<span class="keyword">char</span> *)<span class="keyword">this</span> + <span class="number">520</span>);</div><div class="line">  EnterCriticalSection((LPCRITICAL_SECTION)<span class="keyword">this</span> + <span class="number">13</span>);</div><div class="line">  <span class="keyword">if</span> ( !Memory::PreReservedSectionAllocWrapper::EnsurePreReservedRegionInternal(v4, v6, v7) )</div><div class="line">  &#123;</div><div class="line">LABEL_14:</div><div class="line">    v10 = <span class="number">0</span>i64;</div><div class="line">    <span class="keyword">goto</span> LABEL_7;</div><div class="line">  &#125;</div><div class="line">  LODWORD(v8) = <span class="number">-1</span>;</div><div class="line">  v9 = dwSize / (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(dword_180744D14 &lt;&lt; <span class="number">12</span>);</div><div class="line">  <span class="keyword">if</span> ( !lpAddress )</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</div><div class="line">    &#123;</div><div class="line">      v12 = BVStatic&lt;<span class="number">4096</span>&gt;::GetNextBit(v4, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v8 + <span class="number">1</span>));</div><div class="line">      LODWORD(v8) = v12;</div><div class="line">      <span class="keyword">if</span> ( <span class="number">4096</span> - v12 &lt; v9 || v12 == <span class="number">-1</span> )</div><div class="line">        <span class="keyword">goto</span> LABEL_14;</div><div class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)BVStatic&lt;<span class="number">4096</span>&gt;::TestRange(v4, v12, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v9) )</div><div class="line">      &#123;</div><div class="line">        v10 = (<span class="keyword">void</span> *)(*((_QWORD *)v4 + <span class="number">64</span>) + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)((_DWORD)v8 * dword_180744D14 &lt;&lt; <span class="number">12</span>));</div><div class="line">        <span class="keyword">goto</span> LABEL_4;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  v10 = lpAddress;</div><div class="line">  v8 = (_QWORD)((_QWORD)lpAddress - *((_QWORD *)v4 + <span class="number">64</span>)) / (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(dword_180744D14 &lt;&lt; <span class="number">12</span>);</div><div class="line">LABEL_4:</div><div class="line">  <span class="keyword">if</span> ( v18 &amp; <span class="number">0x1000</span> )</div><div class="line">  &#123;</div><div class="line">    Memory::AutoEnableDynamicCodeGen::AutoEnableDynamicCodeGen((Memory::AutoEnableDynamicCodeGen *)&amp;v13, <span class="number">1</span>);</div><div class="line">    v10 = VirtualAllocEx(*((HANDLE *)v4 + <span class="number">70</span>), v10, dwSize, <span class="number">0x1000</span>u, <span class="number">0x40000010</span>u);</div><div class="line">    Memory::AutoEnableDynamicCodeGen::~AutoEnableDynamicCodeGen((Memory::AutoEnableDynamicCodeGen *)&amp;v13);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ( !lpAddress &amp;&amp; v10 )</div><div class="line">    BVStatic&lt;<span class="number">4096</span>&gt;::ClearRange(v4, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v8, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v9);</div><div class="line">LABEL_7:</div><div class="line">  LeaveCriticalSection(v5);</div><div class="line">  <span class="keyword">return</span> v10;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Commit 远程地址空间时的调用栈如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">003</span>&gt; k</div><div class="line">Child-SP          RetAddr           Call Site</div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd5a0 <span class="number">00007f</span>f8`<span class="number">7b</span>ffc22d chakra!Memory::PreReservedSectionAllocWrapper::Alloc+<span class="number">0x48</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd620 <span class="number">00007f</span>f8`<span class="number">7b</span>ffbacc chakra!Memory::PageSegmentBase&lt;Memory::PreReservedSectionAllocWrapper&gt;::AllocDecommitPages&lt;BVStatic&lt;<span class="number">272</span>&gt;,<span class="number">1</span>&gt;+<span class="number">0x111</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd6c0 <span class="number">00007f</span>f8`<span class="number">7b</span>ffbbfa chakra!Memory::PageAllocatorBase&lt;Memory::PreReservedSectionAllocWrapper,Memory::SegmentBase&lt;Memory::PreReservedSectionAllocWrapper&gt;,Memory::PageSegmentBase&lt;Memory::PreReservedSectionAllocWrapper&gt; &gt;::TryAllocDecommittedPages&lt;<span class="number">1</span>&gt;+<span class="number">0xa4</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd780 <span class="number">00007f</span>f8`<span class="number">7b</span>ffac57 chakra!Memory::PageAllocatorBase&lt;Memory::PreReservedSectionAllocWrapper,Memory::SegmentBase&lt;Memory::PreReservedSectionAllocWrapper&gt;,Memory::PageSegmentBase&lt;Memory::PreReservedSectionAllocWrapper&gt; &gt;::SnailAllocPages&lt;<span class="number">1</span>&gt;+<span class="number">0x52</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd830 <span class="number">00007f</span>f8`<span class="number">7b</span>ffa6d1 chakra!Memory::CustomHeap::Heap&lt;Memory::SectionAllocWrapper,Memory::PreReservedSectionAllocWrapper&gt;::AllocNewPage+<span class="number">0xa3</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd8d0 <span class="number">00007f</span>f8`<span class="number">7b</span>ffa115 chakra!Memory::CustomHeap::Heap&lt;Memory::SectionAllocWrapper,Memory::PreReservedSectionAllocWrapper&gt;::Alloc+<span class="number">0xf9</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afd990 <span class="number">00007f</span>f8`<span class="number">7b</span>ffa21b chakra!EmitBufferManager&lt;Memory::SectionAllocWrapper,Memory::PreReservedSectionAllocWrapper,CriticalSection&gt;::NewAllocation+<span class="number">0x59</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afda20 <span class="number">00007f</span>f8`<span class="number">7b</span>ff9f9c chakra!EmitBufferManager&lt;Memory::SectionAllocWrapper,Memory::PreReservedSectionAllocWrapper,CriticalSection&gt;::AllocateBuffer+<span class="number">0x67</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afda80 <span class="number">00007f</span>f8`<span class="number">7</span>c11d872 chakra!JITOutput::RecordOOPNativeCodeSize+<span class="number">0x78</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afdaf0 <span class="number">00007f</span>f8`<span class="number">7</span>c1aeaef chakra!Encoder::Encode+<span class="number">0x4d2</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afdc90 <span class="number">00007f</span>f8`<span class="number">7</span>c1b11c4 chakra!Func::TryCodegen+<span class="number">0x2ef</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afe580 <span class="number">00007f</span>f8`<span class="number">7b</span>ff9b28 chakra!Func::Codegen+<span class="number">0xf8</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afe9b0 <span class="number">00007f</span>f8`<span class="number">7b</span>ff92d2 chakra!ServerContextManager::CheckLivenessAndAddref+<span class="number">0x1e8</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afead0 <span class="number">00007f</span>f8`<span class="number">7b</span>ff9259 chakra!ServerRemoteCodeGen+<span class="number">0x162</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afeb10 <span class="number">00007f</span>f8`<span class="number">7b</span>ff91ee chakra!ServerRemoteCodeGen+<span class="number">0xe9</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afeb80 <span class="number">00007f</span>f8`<span class="number">886</span>d0053 chakra!ServerRemoteCodeGen+<span class="number">0x7e</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afebf0 <span class="number">00007f</span>f8`<span class="number">887389b</span>8 RPCRT4!Invoke+<span class="number">0x73</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>afec50 <span class="number">00007f</span>f8`<span class="number">88731041</span> RPCRT4!Ndr64StubWorker+<span class="number">0xbe8</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff320 <span class="number">00007f</span>f8`<span class="number">886b</span>193f RPCRT4!NdrServerCallNdr64+<span class="number">0x41</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff370 <span class="number">00007f</span>f8`<span class="number">886b</span>09a6 RPCRT4!DispatchToStubInCNoAvrf+<span class="number">0x2f</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff3c0 <span class="number">00007f</span>f8`<span class="number">886b</span>151c RPCRT4!RPC_INTERFACE::DispatchToStubWorker+<span class="number">0x1c6</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff490 <span class="number">00007f</span>f8`<span class="number">8869</span>c3a6 RPCRT4!RPC_INTERFACE::DispatchToStubWithObject+<span class="number">0x15c</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff530 <span class="number">00007f</span>f8`<span class="number">8869</span>d00a RPCRT4!LRPC_SCALL::DispatchRequest+<span class="number">0x186</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff610 <span class="number">00007f</span>f8`<span class="number">886</span>a090b RPCRT4!LRPC_SCALL::HandleRequest+<span class="number">0x8ba</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff720 <span class="number">00007f</span>f8`<span class="number">886</span>a2220 RPCRT4!LRPC_ADDRESS::HandleRequest+<span class="number">0x2fb</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff7d0 <span class="number">00007f</span>f8`<span class="number">886</span>a3740 RPCRT4!LRPC_ADDRESS::ProcessIO+<span class="number">0x8d0</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff910 <span class="number">00007f</span>f8`<span class="number">8</span>a319aec RPCRT4!LrpcIoComplete+<span class="number">0xe0</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>aff9b0 <span class="number">00007f</span>f8`<span class="number">8</span>a317a37 ntdll!TppAlpcpExecuteCallback+<span class="number">0x26c</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>affa20 <span class="number">00007f</span>f8`<span class="number">882e66</span>cd ntdll!TppWorkerThread+<span class="number">0x407</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>affdd0 <span class="number">00007f</span>f8`<span class="number">8</span>a32666c KERNEL32!BaseThreadInitThunk+<span class="number">0x1d</span></div><div class="line"><span class="number">00000012</span>`<span class="number">02</span>affe00 <span class="number">00000000</span>`<span class="number">00000000</span> ntdll!RtlUserThreadStart+<span class="number">0x2c</span></div></pre></td></tr></table></figure></p>
<p>该过程完成之后，远程地址空间被 commit ，空间属性被设置为 PAGE_EXECUTE、MEM_PRIVATE</p>
<p>实际写入数据时，调用函数 <code>Memory::PreReservedSectionAllocWrapper::AllocLocal</code> 将 <code>PreReservedSectionAllocWrapper</code> 对象中的 section 在当前 JIT 进程中再映射一份。将生成的 JIT 代码通过内存映射的方式写入 Render 进程中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Encoder::Encode</div><div class="line">    |- CodePageAllocators&lt;Memory::SectionAllocWrapper,Memory::PreReservedSectionAllocWrapper&gt;::AllocLocal      //将远程地址空间映射进本地空间</div><div class="line">    |- EmitBufferManager&lt;CriticalSection&gt;::CommitBuffer                                                        //将编译好的代码写入映射的本地空间中，这样代码便会同时写入远程地址空间</div></pre></td></tr></table></figure>
<h5 id="AllocLocal"><a href="#AllocLocal" class="headerlink" title="AllocLocal"></a>AllocLocal</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AllocLocal  -&gt; Memory::AllocLocalView -&gt; NtMapViewOfSection   // 将远程地址空间映射到本地</div></pre></td></tr></table></figure>
<h5 id="CommitBuffer"><a href="#CommitBuffer" class="headerlink" title="CommitBuffer"></a>CommitBuffer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CommitBuffer -&gt; memcpy                           // 将编译好的数据拷贝到映射的本地空间中</div></pre></td></tr></table></figure>
<h1 id="Bypass-ACG"><a href="#Bypass-ACG" class="headerlink" title="Bypass ACG"></a>Bypass ACG</h1><p>通过前面的分析可以看到 Render 进程中的动态代码段的地址实际上在进程初始化阶段就已经确定了。 这段地址已经处于 Mapped 状态。</p>
<p>考虑如下情况</p>
<ol>
<li>在 Render 进程中使用函数 <code>UnmapViewOfFile</code> 将这段 Mapped 状态的地址变为 unmapped</li>
<li>主动申请刚刚 unmap 的那块内存区域，将其访问属性设置为 Write，在这段内存中写入想要执行的 shellcode</li>
<li>那么在 JIT 进程端调用 <code>VirtualAllocEx</code> commit 这段区域时，尽管这段区域已经被分配了，但 <code>VirtualAllocEx</code> 依然会成功执行，并成功将这段内存空间的访问属性设置成 Exec，并且在第二步中写入的数据也将继续存留在内存中！ 更有甚者，由于这段内存空间已经被 unmapped 了，因此在 JIT 进程端对内存映射的修改将不会影响 Render 进程中的数据！</li>
</ol>
<p>下面笔者通过调试器实际进行测试。</p>
<p>在 <code>Memory::PreReservedSectionAllocWrapper::Alloc</code> 处下断点，运行一段会导致 JIT 的 js。 触发断点， JIT 进程中断在函数处，跟踪到调用 <code>VirtualAllocEx</code> ,此时的寄存器状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">0:001&gt; r</div><div class="line">rax=00000090867fd730 rbx=000001b88011e000 rcx=00000000000005fc</div><div class="line">rdx=000001b88011e000 rsi=0000000000000001 rdi=000001b7cc423a38</div><div class="line">rip=00007ff871b4049b rsp=00000090867fd700 rbp=000001b7cc423c40</div><div class="line"> r8=0000000000002000  r9=0000000000001000 r10=000001b7cc423fd0</div><div class="line">r11=4000000000000000 r12=0000000000000000 r13=000001b7cc423eb0</div><div class="line">r14=000001b880100000 r15=0000000000000000</div><div class="line">iopl=0         nv up ei pl nz na pe nc</div><div class="line">cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202</div><div class="line">chakra!Memory::PreReservedSectionAllocWrapper::Alloc+0xcf:</div><div class="line">00007ff8`71b4049b ff15df4f5c00    call    qword ptr [chakra!_imp_VirtualAllocEx (00007ff8`72105480)] ds:00007ff8`72105480=&#123;EShims!NS_ACGLockdownTelemetry::APIHook_VirtualAllocEx (00007ff8`85843170)&#125;</div></pre></td></tr></table></figure>
<p>其中 rdx 为马上要被 Commit 的地址，此时我们转到 Render 进程中查看地址状态 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">0:001&gt; !address 00000232c07be000 </div><div class="line"></div><div class="line">Usage:                  MappedFile</div><div class="line">Base Address:           00000232`c07a0000</div><div class="line">End Address:            00000232`d07a0000</div><div class="line">Region Size:            00000000`10000000</div><div class="line">State:                  00002000	MEM_RESERVE</div><div class="line">Protect:                &lt;info not present at the target&gt;</div><div class="line">Type:                   00040000	MEM_MAPPED</div><div class="line">Allocation Base:        00000232`c07a0000</div><div class="line">Allocation Protect:     00000010	PAGE_EXECUTE</div><div class="line">Mapped file name:       PageFile</div></pre></td></tr></table></figure>
<p>地址处于 Mapped 状态。主动 unmap 这段内存，再次查看内存状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">0:001&gt; !address 00000232c07be000 </div><div class="line"></div><div class="line">Usage:                  Free</div><div class="line">Base Address:           00000232`c07a0000</div><div class="line">End Address:            00000232`d07a0000</div><div class="line">Region Size:            00000000`10000000</div><div class="line">State:                  00010000	MEM_FREE</div><div class="line">Protect:                00000001	PAGE_NOACCESS</div><div class="line">Type:                   &lt;info not present at the target&gt;</div></pre></td></tr></table></figure>
<p>主动申请这段内存为 Write</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">0:001&gt; !address 00000232c07be000 </div><div class="line"></div><div class="line">Usage:                  &lt;unknown&gt;</div><div class="line">Base Address:           00000232`c07b0000</div><div class="line">End Address:            00000232`c07c1000</div><div class="line">Region Size:            00000000`00011000</div><div class="line">State:                  00001000	MEM_COMMIT</div><div class="line">Protect:                00000004	PAGE_READWRITE</div><div class="line">Type:                   00020000	MEM_PRIVATE</div><div class="line">Allocation Base:        00000232`c07b0000</div><div class="line">Allocation Protect:     00000004	PAGE_READWRITE</div></pre></td></tr></table></figure>
<p>修改内存内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0:001&gt; ea 00000232c07be000 &quot;Hacked&quot;</div></pre></td></tr></table></figure></p>
<p>回到 JIT 进程，执行 <code>VirtualAllocEx</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">0:001&gt; !address 00000232c07be000 </div><div class="line"></div><div class="line">Usage:                  &lt;unknown&gt;</div><div class="line">Base Address:           00000232`c07be000</div><div class="line">End Address:            00000232`c07c0000</div><div class="line">Region Size:            00000000`00002000</div><div class="line">State:                  00001000	MEM_COMMIT</div><div class="line">Protect:                00000010	PAGE_EXECUTE</div><div class="line">Type:                   00020000	MEM_PRIVATE</div><div class="line">Allocation Base:        00000232`c07b0000</div><div class="line">Allocation Protect:     00000004	PAGE_READWRITE</div></pre></td></tr></table></figure>
<p>查看内存内容,此时我们写入的 shellcode 已经被设置成了 Execute</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">0:001&gt; db 00000232c07be000 </div><div class="line">00000232`c07be000  48 61 63 6b 65 64 00 00-00 00 00 00 00 00 00 00  Hacked..........</div><div class="line">00000232`c07be010  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00000232`c07be020  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00000232`c07be030  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00000232`c07be040  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00000232`c07be050  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00000232`c07be060  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">00000232`c07be070  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</div><div class="line">0:001&gt; !address 00000232c07be000 </div><div class="line"></div><div class="line">Usage:                  &lt;unknown&gt;</div><div class="line">Base Address:           00000232`c07be000</div><div class="line">End Address:            00000232`c07c0000</div><div class="line">Region Size:            00000000`00002000</div><div class="line">State:                  00001000	MEM_COMMIT</div><div class="line">Protect:                00000010	PAGE_EXECUTE</div><div class="line">Type:                   00020000	MEM_PRIVATE</div><div class="line">Allocation Base:        00000232`c07b0000</div><div class="line">Allocation Protect:     00000004	PAGE_READWRITE</div></pre></td></tr></table></figure>
<p>这里需要注意的一点是，在 Render 进程中申请的内存边界一定不能正好处于 JIT 进程申请的内存块中，即不能出现下面所示的情况，否则 <code>VirtialAllocEx</code> 会抛出 <code>ERROR_INVALID_ADDRESS</code> 异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">         ------VirtialAllocEx-------</div><div class="line">         |                         |</div><div class="line"></div><div class="line">--RenderAlloc--</div><div class="line">|             |</div></pre></td></tr></table></figure>
<h1 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h1><p>微软在上个月对这个漏洞进行了<a href="https://github.com/Microsoft/ChakraCore/commit/7c5326f6e250a7c4d0133b0ddb032a212a198b8d?diff=unified#diff-75094ae78e18d086b1542e005af60052L961" target="_blank" rel="external">修补</a>，针对 VirtualAllocEx 可能会将已经 commit 的对象再次 commit 的情况进行了修改，删除了 <code>VirtualAllocEx</code> 和 <code>VirtualProtectEx</code> 的调用。</p>
<p>补丁之后 JIT 进程将不会再调用 <code>VirtualAllocEx</code> ，从而切断了在 Render 进程中运行时动态申请可执行页的路径。</p>
<p>而由于将 <code>VirtualProtectEx</code> 的使用也删除了，因此为了提高内存使用率，在释放这段共享内存空间时调用函数 <a href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FMemory%20Management%2FVirtual%20Memory%2FNtUnlockVirtualMemory.html" target="_blank" rel="external"><code>UnlockVirtualMemory</code></a> 来完成 <code>VirtualProtectEx(NO_ACCESS)</code> 相同的功能。</p>
<p>去除了 <code>VirtualAllocEx</code> 的调用 Render 进程端可执行的内存便不会在 <code>Alloc</code> 函数中分配。由于使用了共享内存的关系，因此当同一个 Section 在 JIT 进程中 Commit 共享内存时（函数<code>AllocLocalView</code>），Render 进程也会同时 Commit 相应的内存空间。换而言之，之前的设计中主动在 Render 进程中 Commit 内存的操作是不必要的！</p>
<p>（这部分内容笔者不甚了解，因此只能从现象分析出表面的情况，关于共享内存更加深入的情况笔者还在学习中，如有错误还望指正）</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>ACG 的相关分析笔者在 RS2 预览版阶段就已经进行了，在预览版本中 JIT 进程对于 Render 进程内存的控制还是全程使用 <code>VirtualAllcEX</code>，即先把内存 Commit 成 Execute，在写入数据时将内存访问修改为 Write，写入完成之后再修改成 Execute。在发布版中，内存操作改为了使用内存映射来实现。当时主观上就没有进行进一步的思考，没有想到内存映射过后的地址在 Render 进程中也是可以自由操控的，在 Render 进程获得了内存权限之后，可以对自己范围内的地址进行任意操作。主要的原因和之前通过 Duplicate 绕过 ACG 一样，还是对系统内部的概念理解不深刻和全面。</p>
<p>这个漏洞的主要原因在笔者看来是进程间协作时对内存映射没有一个同步管理机制造成的，一个进程中对内存映射进行修改之后另一个进程并不会得到通知仍使用之前的数据进行操作从而产生问题。像这种两个进程间协同作用的情况，可以针对协同作用的对象，协作时的通信方法等关键点进行重点思考。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200" target="_blank" rel="external">https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200</a><br>[2] <a href="https://github.com/Microsoft/ChakraCore/commit/7c5326f6e250a7c4d0133b0ddb032a212a198b8d?diff=unified#diff-75094ae78e18d086b1542e005af60052L961" target="_blank" rel="external">https://github.com/Microsoft/ChakraCore/commit/7c5326f6e250a7c4d0133b0ddb032a212a198b8d?diff=unified#diff-75094ae78e18d086b1542e005af60052L961</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/" data-id="cjli23ftw0002f4uueaeo986h" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/05/22/MapViewOfSection_and_Shared_Memory/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          MapViewOfSection and Shared-Memory
        
      </div>
    </a>
  
  
    <a href="/2018/03/11/VS_Extension/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Visual Studio 注释扩展</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/24/Babel_HelloWorld/">Babel HelloWorld</a>
          </li>
        
          <li>
            <a href="/2018/09/07/EVM_Simulator/">EVM Simulator</a>
          </li>
        
          <li>
            <a href="/2018/09/07/EVM_EMU/">EVM Emulator</a>
          </li>
        
          <li>
            <a href="/2018/08/31/VaribleOverlap/">ETH Varible Overlap</a>
          </li>
        
          <li>
            <a href="/2018/07/23/EOS_build/">EOS 搭建指南</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget tag">
    <h3 class="title">Site Links</h3>
    <ul class="entry">
    <li><a href="http://5alt.me" title="5alt">5alt's Blog</a></li>
    </ul>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 mohaplus<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com" class="mobile-nav-link">github</a>
  
</nav>
    
<script>
  var disqus_shortname = 'mohamoha';
  
  var disqus_url = 'http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>