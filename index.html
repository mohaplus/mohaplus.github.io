<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>么哈么哈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Too young, Too simple, Sometime naive">
<meta property="og:type" content="website">
<meta property="og:title" content="么哈么哈">
<meta property="og:url" content="http://mohamoha.club/index.html">
<meta property="og:site_name" content="么哈么哈">
<meta property="og:description" content="Too young, Too simple, Sometime naive">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="么哈么哈">
<meta name="twitter:description" content="Too young, Too simple, Sometime naive">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">么哈么哈</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Too young, Too simple, Sometime naive</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://github.com">github</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://mohamoha.club"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/13/hello-world/" class="article-date">
  <time datetime="2017-09-12T16:00:00.000Z" itemprop="datePublished">2017-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/13/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/helloworld/background.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2017/09/13/hello-world/" data-id="cjli23fue000ef4uuhuy3oylp" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2017/09/13/hello-world/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-VaribleOverlap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/31/VaribleOverlap/" class="article-date">
  <time datetime="2018-08-30T16:00:00.000Z" itemprop="datePublished">2018-08-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/31/VaribleOverlap/">ETH Varible Overlap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>经过对 ETH 以及其运行时环境 EVM 的初步研究，我们在合约层面和虚拟机层面分别发现了一些问题，其中有些问题可能导致非常严重的后果，值得 ETH 智能合约的开发者注意。变量覆盖问题就是其中非常典型的一种，有很多以太坊安全研究人员都已经发现了这个问题，但是分析大都停留在结果层面，没有做进一步的探讨。本文将从变量覆盖这个问题入手结合 EVM 虚拟机和 Solidity 编译器的源码详细分析这个问题的表现，可能产生的影响，以及最终导致这个问题的 solidity 编译器根源所在。</p>
<h2 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h2><p>在某些合约中，我们发现在函数内部对 struct 类型的临时变量进行修改，会在某些情况下覆盖已有的全局变量。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>; </div><div class="line"><span class="comment">// A Locked Name Registrar</span></div><div class="line">contract Locked &#123;</div><div class="line">    bool public unlocked = <span class="literal">false</span>;  <span class="comment">// registrar locked, no name updates</span></div><div class="line">    </div><div class="line">    struct NameRecord &#123; <span class="comment">// map hashes to addresses</span></div><div class="line">        bytes32 name; <span class="comment">// </span></div><div class="line">        address mappedAddress;</div><div class="line">    &#125;</div><div class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> NameRecord) public registeredNameRecord; <span class="comment">// records who registered names </span></div><div class="line">    mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> address) public resolve; <span class="comment">// resolves hashes to addresses</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">bytes32 _name, address _mappedAddress</span>) <span class="title">public</span> </span>&#123;</div><div class="line">        <span class="comment">// set up the new NameRecord</span></div><div class="line">        NameRecord newRecord;</div><div class="line">        newRecord.name = _name;</div><div class="line">        newRecord.mappedAddress = _mappedAddress; </div><div class="line">        resolve[_name] = _mappedAddress;</div><div class="line">        registeredNameRecord[msg.sender] = newRecord; </div><div class="line">        <span class="built_in">require</span>(unlocked); <span class="comment">// only allow registrations if contract is unlocked</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>合约的源码如上面所示，在正常情况下，由于合约并没有提供修改 unlocked 的接口，因此不太可能达到修改它的目的。但是实际上我们在测试中发现，只要调用合约的 register 方法就可以修改 unlocked。</p>
<p><img src="/VaribleOverlap/varible.png" alt=""></p>
        
          <p class="article-more-link">
            <a href="/2018/08/31/VaribleOverlap/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/08/31/VaribleOverlap/" data-id="cjli23fud000df4uuexcyjrf8" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/08/31/VaribleOverlap/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-EOS_build" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/23/EOS_build/" class="article-date">
  <time datetime="2018-07-22T16:00:00.000Z" itemprop="datePublished">2018-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/23/EOS_build/">EOS 搭建指南</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>EOS 与 ETH 相比，其架构更加复杂，由于其主链刚刚上线不久因此 EOS 中的合约数量也不多，为了学习和理解 EOS 的相关知识，笔者跟随 <a href="">EOS 官网</a> 的教程对 EOS 进行了初步的了解，由于网上目前的资料参差不齐，因此将学习过程中遇到的问题记录在此，以备查阅。</p>
<h2 id="EOS-源码编译"><a href="#EOS-源码编译" class="headerlink" title="EOS 源码编译"></a>EOS 源码编译</h2><p>编译过程比较繁琐，网上也有很多教程，这里不再赘述，仅记一下笔者搭建过程中遇到的一些坑。由于 EOS 代码版本迭代十分频繁，因此网上许多基于旧版本 EOS 源码的搭建教程并不适用。这里推荐使用其源码中提供的脚本 <code>eosio_build.sh</code> 完成工作。这个脚本会根据编译时的实际环境调用不同系统的专用脚本来完成工作，笔者的环境是 Ubuntu_16 因此最后会调用 <code>/scripts/eosio_build_ubuntu.sh</code> 进行编译。其中比较重要的两个点是首先需要安装最新版本的 boost ，其次是需要安装 OpenSSL，安装完成之后一般来说就可以成功的编译起来了。</p>
<p>如果编译过程中提示系统硬件配置等信息不符合要求，如内存硬盘等等不够大，可以直接修改脚本中的判断条件。比如默认状态下脚本要求 EOS 编译的内存要有 8G ，但是如果我们在虚拟机中进行编译内存常常不满足要求，此时只需要修改用于进行硬件检测的编译脚本即可，将这个判断条件改小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if [ &quot;$&#123;MEM_MEG&#125;&quot; -lt 7000 ]; then</div><div class="line">		printf &quot;\\tYour system must have 7 or more Gigabytes of physical memory installed.\\n&quot;</div><div class="line">		printf &quot;\\tExiting now.\\n&quot;</div><div class="line">		exit 1</div><div class="line">fi</div></pre></td></tr></table></figure>
        
          <p class="article-more-link">
            <a href="/2018/07/23/EOS_build/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/07/23/EOS_build/" data-id="cjli23fu40006f4uuu6ny5zjg" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/07/23/EOS_build/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Ethernaut_zeppelin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/21/Ethernaut_zeppelin/" class="article-date">
  <time datetime="2018-06-20T16:00:00.000Z" itemprop="datePublished">2018-06-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/21/Ethernaut_zeppelin/">Ethernaut Zeppelin 学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://ethernaut.zeppelin.solutions/" target="_blank" rel="external">https://ethernaut.zeppelin.solutions/</a> 网站上列出了一系列智能合约在编写过程中可能产生的问题，可以帮助初学者很好的了解智能合约</p>
<p><a href="https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md" target="_blank" rel="external">https://github.com/OpenZeppelin/ethernaut/blob/master/gamedata/descriptions/pages/help.md</a> 帮助文档</p>
<p>花了一整天假装自己 AC 了所有的题目，这里把过程中的一点总结和经验记录一下，留以备忘</p>
<p><img src="/zeppelin/ac.png" alt=""></p>
<h2 id="Hello"><a href="#Hello" class="headerlink" title="Hello"></a>Hello</h2><p>题目是用来帮助熟悉平台的。这里简单记录一下平台和 Remix 编辑器的基本操作</p>
<p>平台首先需要安装 MetaMask 插件并登陆账户，如果打开平台时没有登陆账户，那么登陆之后需要刷新页面使账户信息生效。</p>
<p>Remix 是非常好用的在线编辑平台，其不仅可以编译 solidity 代码生成自己的测试合约，也可以根据地址映射链上已有的合约</p>
<p><img src="/zeppelin/background.png" alt=""></p>
<p>在顶部菜单中可以选择合约运行的环境，运行合约的账户。并且可以配置执行合约代码时所带有的 gas 和 value 相当于调用合约时的 <code>.value().gas()</code></p>
<p><img src="/zeppelin/Environment.png" alt=""></p>
<p>在执行了合约代码之后可以点击下方的 debug 按钮对合约代码进行调试</p>
<p><img src="/zeppelin/debug1.png" alt=""></p>
<p>调试功能十分强大，可以查看运行时的栈，memory，opcode，等几乎所有的 EVM 关键信息</p>
<p><img src="/zeppelin/debug2.png" alt=""></p>
        
          <p class="article-more-link">
            <a href="/2018/06/21/Ethernaut_zeppelin/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/06/21/Ethernaut_zeppelin/" data-id="cjli23fu70008f4uuwexp8lzd" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/06/21/Ethernaut_zeppelin/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Bypass_ACG_with_OpenProcess" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/03/Bypass_ACG_with_OpenProcess/" class="article-date">
  <time datetime="2018-06-02T16:00:00.000Z" itemprop="datePublished">2018-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/03/Bypass_ACG_with_OpenProcess/">Bypass ACG With OpenProcess</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200" target="_blank" rel="external">https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200</a> p0 研究者 ifratric 提出的一种绕过 ACG 保护的方案，即通过修改同一 AppContainer 中的其他 MicrosoftEdgeCp.exe 进程的内存来阻止另一个进程开启 ACG 保护</p>
<h1 id="ACG-的开启"><a href="#ACG-的开启" class="headerlink" title="ACG 的开启"></a>ACG 的开启</h1><p>进程的 ACG 需要调用函数 <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh769088(v=vs.85" target="_blank" rel="external"><code>SetProcessMitigationPolicy</code></a>.aspx) 或者 <a href="http://hex.pp.ua/nt/NtSetInformationProcess.php" target="_blank" rel="external"><code>ZwSetInformationProcess</code></a> 来开启。这里我们主要关注 <code>SetProcessMitigationPolicy</code> ,函数的原型如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">BOOL WINAPI <span class="title">SetProcessMitigationPolicy</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">  _In_ PROCESS_MITIGATION_POLICY MitigationPolicy,</span></span></div><div class="line"><span class="function"><span class="params">  _In_ PVOID                     lpBuffer,</span></span></div><div class="line"><span class="function"><span class="params">  _In_ SIZE_T                    dwLength</span></span></div><div class="line"><span class="function"><span class="params">)</span></span>;</div></pre></td></tr></table></figure>
<p>第一个参数指定要设定的缓解策略类型，第二个参数根据第一个参数指定不同的 Policy 数据，第三个参数指定第二个参数的长度。</p>
        
          <p class="article-more-link">
            <a href="/2018/06/03/Bypass_ACG_with_OpenProcess/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/06/03/Bypass_ACG_with_OpenProcess/" data-id="cjli23ftz0003f4uuf30zhz0m" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/06/03/Bypass_ACG_with_OpenProcess/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-MapViewOfSection_and_Shared_Memory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/22/MapViewOfSection_and_Shared_Memory/" class="article-date">
  <time datetime="2018-05-21T16:00:00.000Z" itemprop="datePublished">2018-05-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/22/MapViewOfSection_and_Shared_Memory/">MapViewOfSection and Shared-Memory</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前对于 <a href="http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/#%E8%A1%A5%E4%B8%81">UnmapViewOfFile</a> 的分析中留了一个坑，即使用 SECTION 在进程之间共享内存的情况。拖了几个星期，终于把这个问题稍稍搞明白了一点。这里将相关的知识点记录一下。</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>微软对于 UnmapViewOfFile 绕过 ACG 这种攻击方式的补丁是在 JIT 进程端移除了 VirtualAlloc/VirtualProtect 操作，从而切断了将其他属性内存转化为可执行页的路径。于是笔者产生了疑问：在不使用 VirtualAlloc/VirtualProtect 的情况下 Render 中的内存页是如何 commit 的</p>
<p>在打上补丁之后，内存的分配操作只剩下 AllocLocalView ，查看函数源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AllocLocalView&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    process = GetCurrentProcess();</div><div class="line">    NtdllLibrary::Instance-&gt;MapViewOfSection(sectionHandle, process, &amp;address, <span class="literal">NULL</span>, viewSize, &amp;mapOffset, &amp;viewSize, NtdllLibrary::ViewUnmap, <span class="literal">NULL</span>, flags);</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码中调用 MapViewOfSection 在当前进程中为这个用来共享内存的 Section ,其中 CommitSize 参数为 viewSize。实际调试 Edge， 在这个调用上下断点 JIT 进程断在此处，此时 Render 中的虚拟内存地址已经由之前那次 Map 操作确定了，查看 Render 进程中对应的虚拟地址空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">0:001&gt; dd  1ec`e6240000 </div><div class="line">000001ec`e6240000  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240010  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240020  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240030  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240040  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240050  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240060  ???????? ???????? ???????? ????????</div><div class="line">000001ec`e6240070  ???????? ???????? ???????? ????????</div></pre></td></tr></table></figure>
<p>执行这次函数调用，再次查看 Render 进程地址，发现此时对应的虚拟地址已经映射了物理地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">0:001&gt; dd  1ec`e6240000 </div><div class="line">000001ec`e6240000  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240010  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240020  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240030  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240040  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240050  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240060  00000000 00000000 00000000 00000000</div><div class="line">000001ec`e6240070  00000000 00000000 00000000 00000000</div></pre></td></tr></table></figure>
        
          <p class="article-more-link">
            <a href="/2018/05/22/MapViewOfSection_and_Shared_Memory/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/05/22/MapViewOfSection_and_Shared_Memory/" data-id="cjli23fua000af4uutfp9y4kg" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/05/22/MapViewOfSection_and_Shared_Memory/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Bypass_ACG_with_UnmapViewOfFile" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/" class="article-date">
  <time datetime="2018-04-24T16:00:00.000Z" itemprop="datePublished">2018-04-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/">Bypass ACG With UnmapViewOfFile</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200" target="_blank" rel="external">https://bugs.chromium.org/p/project-zero/issues/detail?id=1435&amp;can=1&amp;q=&amp;start=1200</a> p0 研究者 ifratric 提出的一种绕过 ACG 保护的方案，即通过调用函数 <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366882.aspx" target="_blank" rel="external"><code>UnmapViewOfFile</code></a> 来预先修改内存块内容，从而在可执行页上加入攻击者自定义代码。</p>
<h1 id="Remote-JIT"><a href="#Remote-JIT" class="headerlink" title="Remote JIT"></a>Remote JIT</h1><p>开启了 ACG 保护之后进程将不能够申请未签名代码页。但是现代浏览器为了提高响应效率，都提供了 JIT 功能用于把 JS 代码编译成本地代码。该功能的实现依赖于在进程空间中动态的生成未签名的代码页。为了同时支持 ACG 和 JIT，Chakra 将其 JIT 功能移动到一个单独的进程中，该进程在其独立的沙箱中运行。JIT进程负责将 JavaScript 编译为本地代码并将其映射到请求进程。渲染进程本身不允许直接映射或修改其自己的JIT代码页。</p>
<h2 id="JIT-地址管理"><a href="#JIT-地址管理" class="headerlink" title="JIT 地址管理"></a>JIT 地址管理</h2><p>（由于笔者对于 ACG 的分析基于的 Edge 版本较老因此，可能有些地方不匹配）<br>远程分配的地址空间来源于本进程中的 <code>PreReservedSectionAllocWrapper</code> 对象，该对象在 JIT 进程启动时进行初始化，专门负责管理那些远程保留空间。对象的结构简单表示如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PreReservedSectionAllocWrapper</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">    BVStatic&lt;PreReservedAllocationSegmentCount&gt;     freeSegments;                  <span class="comment">//0x00             // 用于索引整块内存空间，检查内存状态</span></div><div class="line">    LPVOID                                          preReservedStartAddress;       <span class="comment">//0x200            // 当前应该分配出去的地址</span></div><div class="line">    CriticalSection                                 cs;                            <span class="comment">//0x208</span></div><div class="line">                        |-  PRTL_CRITICAL_SECTION_DEBUG DebugInfo;                 <span class="comment">//0x208</span></div><div class="line">                        |-  LONG LockCount;                                        <span class="comment">//0x210</span></div><div class="line">                        |-  LONG RecursionCount;                                   <span class="comment">//0x214</span></div><div class="line">                        |-  HANDLE OwningThread;                                   <span class="comment">//0x218   from the thread's ClientId-&gt;UniqueThread</span></div><div class="line">                        |-  HANDLE LockSemaphore;                                  <span class="comment">//0x220</span></div><div class="line">                        |-  ULONG_PTR SpinCount                                    <span class="comment">//0x228                                                                      </span></div><div class="line">    HANDLE process;                                                                <span class="comment">//0x230             // 远程进程句柄</span></div><div class="line">    HANDLE section;                                                                <span class="comment">//0x238             // 远程地址 section 句柄</span></div><div class="line">    EnsurePreReservedRegionInternal();                                             <span class="comment">// 用于检查是否还存在可管理的 RESERVE 属性内存，若不存在，则在分配之</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
        
          <p class="article-more-link">
            <a href="/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/" data-id="cjli23ftw0002f4uueaeo986h" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/04/25/Bypass_ACG_with_UnmapViewOfFile/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-VS_Extension" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/11/VS_Extension/" class="article-date">
  <time datetime="2018-03-10T16:00:00.000Z" itemprop="datePublished">2018-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/11/VS_Extension/">Visual Studio 注释扩展</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在阅读大型工程源代码的时候经常需要根据自己的理解为代码添加某些注释，直接在源码文件中的修改有可能会导致工程重新编译，git 更新代码时产生冲突等情况，更有甚者一旦代码通过 git 更新之后，自己添加的注释将不会出现在新代码中；如果将注释写在源码之外的文件中，在以后查阅和对照时又会有其他新的麻烦。基于以上需求，笔者实现了一个 Visual Studio 中的注释插件，可以在源码文件之外独立添加注释，并且在查看源码时会在对应的位置显示注释。</p>
<p>效果如图所示</p>
<p><img src="\VsExtension\15.png" alt=""></p>
<p>在编写过程中参考了<a href="http://michaelscodingspot.com/2017/10/08/visual-studio-2017-extension-development-tutorial-part-1/" target="_blank" rel="external">这篇文章</a> 中插件的实现。感谢这位作者的分享。</p>
<h2 id="Visual-Studio-Extension"><a href="#Visual-Studio-Extension" class="headerlink" title="Visual Studio Extension"></a>Visual Studio Extension</h2><p>微软为 vs 扩展的开发者提供了一套完整的<a href="https://docs.microsoft.com/zh-cn/visualstudio/extensibility/index" target="_blank" rel="external">开发文档</a>，以便开发者可以根据自己的需求扩展 Visual Studio 的功能。理论上而言可用的扩展点如下</p>
<ul>
<li>命令和菜单</li>
<li>工具窗口</li>
<li>编辑器窗口</li>
<li>语言服务</li>
<li>项目扩展</li>
<li>用户设置</li>
<li>属性和属性窗口</li>
<li>Visual Studio 独立 Shell</li>
</ul>
<p>其他更多关于 VS 扩展的内容可以参见上面的开发文档，其中提供了大量的例子可以参考。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>下面笔者将一步一步记录下整个插件的编写过程，以便之后改进和复现。</p>
        
          <p class="article-more-link">
            <a href="/2018/03/11/VS_Extension/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/03/11/VS_Extension/" data-id="cjli23fuc000cf4uuh5759yro" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/03/11/VS_Extension/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Edge_thredhold" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/13/Edge_thredhold/" class="article-date">
  <time datetime="2018-01-12T16:00:00.000Z" itemprop="datePublished">2018-01-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/13/Edge_thredhold/">也谈 “Spectre” CPU 漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>元旦回来 P0 就放出了 2018 年的第一个大新闻，多款处理器被曝出存在安全漏洞可以泄露某些敏感信息，P0 将其分别命名为 “Spectre” 和 “MeltDown”。其中 “Spectre” 漏洞是由于 CPU 的分支预测进而导致的缓存信息泄露，其效果可以越界读取某些内容。</p>
<p>根据原理上来说 “Spectre” 是可以并且比较容易在浏览器中通过 js 相关技术实现攻击的，在 P0 的论文后也附加了一个 C 语言实现的 demo。出于对这种攻击理论上的认可我们开始尝试通过 js 来实现 “Spectre” 的漏洞利用。经过四天的研究我们终于 “全球首发” “Spectre” 漏洞在线检测工具，虽然依然很不完善但是效果却出乎我们所有人的意料。<a href="https://xlab.tencent.com/special/spectre/spectre_check.html" target="_blank" rel="external">检测工具地址</a></p>
<p><img src="/Spectre/online.png" alt=""></p>
<p>实现的代码全是 JS 因此可以直接通过前端获取，经过 Exp-sky 师傅的润色代码也大体上可读（ps：如果知道要放出来的话变量命名写的时候就不会那么随意了~ orz）。这里记录一下代码编写过程中的几个问题，以备以后查询。</p>
        
          <p class="article-more-link">
            <a href="/2018/01/13/Edge_thredhold/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2018/01/13/Edge_thredhold/" data-id="cjli23fu50007f4uug8hzwawn" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2018/01/13/Edge_thredhold/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Decrypt_Pyc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/27/Decrypt_Pyc/" class="article-date">
  <time datetime="2017-12-26T16:00:00.000Z" itemprop="datePublished">2017-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/27/Decrypt_Pyc/">Decrypt PYC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="PYC"><a href="#PYC" class="headerlink" title="PYC"></a>PYC</h2><p>PYC 是 Python 文件经过编译之后形成的一种文件格式，可以提高加载效率用来为其他 Python 程序提供函数接口等功能。</p>
<p>其文件格式如下，主要由头部四字节的 Magic 字段和 4字节的 timestap 以及 r_object 结构组成。r_object 对象是 PYC 文件的主要内容，包括了 python 文件所编译形成的 Opcode、常量、值等一系列信息。其更具体的信息可以在 python 自带的 marshal 库中找到 <code>Python/marshal.c</code><br>
        
          <p class="article-more-link">
            <a href="/2017/12/27/Decrypt_Pyc/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://mohamoha.club/2017/12/27/Decrypt_Pyc/" data-id="cjli23fu30005f4uu89tsaue6" class="article-share-link">Share</a>
      
        <a href="http://mohamoha.club/2017/12/27/Decrypt_Pyc/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/08/31/VaribleOverlap/">ETH Varible Overlap</a>
          </li>
        
          <li>
            <a href="/2018/07/23/EOS_build/">EOS 搭建指南</a>
          </li>
        
          <li>
            <a href="/2018/06/21/Ethernaut_zeppelin/">Ethernaut Zeppelin 学习</a>
          </li>
        
          <li>
            <a href="/2018/06/03/Bypass_ACG_with_OpenProcess/">Bypass ACG With OpenProcess</a>
          </li>
        
          <li>
            <a href="/2018/05/22/MapViewOfSection_and_Shared_Memory/">MapViewOfSection and Shared-Memory</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget tag">
    <h3 class="title">Site Links</h3>
    <ul class="entry">
    <li><a href="http://5alt.me" title="5alt">5alt's Blog</a></li>
    </ul>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 mohaplus<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com" class="mobile-nav-link">github</a>
  
</nav>
    
<script>
  var disqus_shortname = 'mohamoha';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>